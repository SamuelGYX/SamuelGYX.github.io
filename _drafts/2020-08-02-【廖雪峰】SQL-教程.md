---
layout: post
title:  【廖雪峰】SQL 教程
date:   2020-08-02
categories: Database
---

## 第一章 入门介绍

- 简单地说，SQL就是访问和处理关系数据库的计算机标准语言
- NoSQL
  - MongoDB、Cassandra、Dynamo等
  - 它们都不是关系数据库

### 1. 关系型数据库

- 发展

  - 用户数据
    - 要保存用户的数据，一个最简单的方法是把用户数据写入文件
    - 问题
      - 读写文件并解析出数据需要大量重复代码
      - 从成千上万的数据中快速查询出指定数据需要复杂的逻辑
      - 效率低，容易出错，而且每个应用程序访问数据的接口都不相同，数据难以复用
  - 数据库
    - 所以，数据库作为一种专门管理数据的软件就出现了
    - 应用程序不需要自己管理数据，而是通过数据库软件提供的接口来读写数据，至于数据本身如何存储到文件，那是数据库软件的事情，应用程序自己并不关心
    - 这样一来，编写应用程序的时候，数据读写的功能就被大大地简化了

- 数据模型

  - 分类
    - 层次模型
    - 网状模型
    - 关系模型
  - 最终
    - 基于关系模型的关系数据库获得了绝对市场份额，因为关系模型理解和使用起来最简单

- 数据类型

  | 名称         | 类型           | 说明                                                         |
  | ------------ | -------------- | ------------------------------------------------------------ |
  | INT          | 整型           | 4字节整数类型，范围约+/-21亿                                 |
  | BIGINT       | 长整型         | 8字节整数类型，范围约+/-922亿亿                              |
  | REAL         | 浮点型         | 4字节浮点数，范围约+/-1038                                   |
  | DOUBLE       | 浮点型         | 8字节浮点数，范围约+/-10308                                  |
  | DECIMAL(M,N) | 高精度小数     | 由用户指定精度的小数，例如，DECIMAL(20,10)表示一共20位，其中小数10位，通常用于财务计算 |
  | CHAR(N)      | 定长字符串     | 存储指定长度的字符串，例如，CHAR(100)总是存储100个字符的字符串 |
  | VARCHAR(N)   | 变长字符串     | 存储可变长度的字符串，例如，VARCHAR(100)可以存储0~100个字符的字符串 |
  | BOOLEAN      | 布尔类型       | 存储True或者False                                            |
  | DATE         | 日期类型       | 存储日期，例如，2018-06-22                                   |
  | TIME         | 时间类型       | 存储时间，例如，12:20:59                                     |
  | DATETIME     | 日期和时间类型 | 存储日期+时间，例如，2018-06-22 12:20:59                     |

  - 通常来说，`BIGINT`能满足整数存储的需求，`VARCHAR(N)`能满足字符串存储的需求，这两种类型是使用最广泛的

- 主流关系数据库

  - 商用数据库，例如：[Oracle](https://www.oracle.com)，[SQL Server](https://www.microsoft.com/sql-server/)，[DB2](https://www.ibm.com/db2/)等
  - 开源数据库，例如：[MySQL](https://www.mysql.com/)，[PostgreSQL](https://www.postgresql.org/)等
  - 桌面数据库，以微软[Access](https://products.office.com/access)为代表，适合桌面应用程序使用
  - 嵌入式数据库，以[Sqlite](https://sqlite.org/)为代表，适合手机应用和桌面程序

- SQL 语言

  - 简介
    - SQL是结构化查询语言（Structured Query Language）的缩写，用来访问和操作数据库系统
    - 虽然SQL已经被ANSI组织定义为标准，不幸地是，各个不同的数据库对标准的SQL支持不太一致，并且，大部分数据库都在标准的SQL上做了扩展
    - 例如，Oracle把自己扩展的SQL称为`PL/SQL`，Microsoft把自己扩展的SQL称为`T-SQL`
  - 组成部分
    - DDL
      - Data Definition Language
      - 允许用户定义数据，也就是创建表、删除表、修改表结构这些操作
      - 通常，DDL由数据库管理员执行
    - DML
      - Data Manipulation Language
      - 为用户提供添加、删除、更新数据的能力，这些是应用程序对数据库的日常操作
    - DQL
      - Data Query Language
      - 允许用户查询数据，这也是通常最频繁的数据库日常操作

- 大小写问题

  - SQL语言关键字不区分大小写
  - 本教程约定：SQL关键字总是大写，以示突出，表名和列名均使用小写

### 2. 安装 MySQL

- 简介
  - MySQL是目前应用最广泛的开源关系数据库
- 历史
  - MySQL最早是由瑞典的MySQL AB公司开发
  - 该公司在2008年被SUN公司收购
  - 紧接着，SUN公司在2009年被Oracle公司收购，所以MySQL最终就变成了Oracle旗下的产品
- 内部引擎
  - 简介
    - 和其他关系数据库有所不同的是，MySQL本身实际上只是一个SQL接口，它的内部还包含了多种数据引擎
    - 对用户而言，切换MySQL引擎不影响自己写的应用程序使用MySQL的接口
    - 使用MySQL时，不同的表还可以使用不同的数据库引擎
  - 分类
    - InnoDB
      - 由Innobase Oy公司开发的一款支持事务的数据库引擎，2006年被Oracle收购
    - MyISAM
      - MySQL早期集成的默认数据库引擎，不支持事务
- 衍生版本
  - MariaDB
    - 由MySQL的创始人创建的一个开源分支版本，使用XtraDB引擎
  - Aurora
    - 由Amazon改进的一个MySQL版本，专门提供给在AWS托管MySQL用户，号称5倍的性能提升
  - PolarDB
    - 由Alibaba改进的一个MySQL版本，专门提供给在[阿里云](https://promotion.aliyun.com/ntms/yunparter/invite.html?userCode=cz36baxa)托管的MySQL用户，号称6倍的性能提升
- 官方版本
  - 分类
    - Community Edition：社区开源版本，免费
    - Standard Edition：标准版
    - Enterprise Edition：企业版
    - Cluster Carrier Grade Edition：集群版
  - 说明
    - 以上版本的功能依次递增，价格也依次递增
    - 不过，功能增加的主要是监控、集群等管理功能，对于基本的SQL功能是完全一样的
- 安装运行

### 3. 关系模型

- 行
  - 表的每一行称为记录（Record），记录是一个逻辑意义上的数据
- 列
  - 表的每一列称为字段（Column），同一个表的每一行记录都拥有相同的若干字段
  - 字段定义了数据类型（整型、浮点型、字符串、日期等），以及是否允许为`NULL`
- `NULL`
  - `NULL`表示字段数据不存在
  - 通常情况下，字段应该避免允许为NULL
  - 不允许为NULL可以简化查询条件，加快查询速度，也利于应用程序读取数据后无需判断是否为NULL

#### 1. 主键

- 简介
  - 对于关系表，有个很重要的约束，就是任意两条记录不能重复
  - 即，能够通过某个字段唯一区分出不同的记录，这个字段被称为主键
- 如何选取
  - 记录一旦插入到表中，主键最好不要再修改，因为主键是用来唯一定位记录的，修改了主键，会造成一系列的影响
  - 所以，选取主键的一个基本原则是：不使用任何业务相关的字段作为主键，例如身份证号、手机号、邮箱地址
  - 主键也不应该允许`NULL`
  - 作为主键最好是完全业务无关的字段，我们一般把这个字段命名为`id`
- 常见`id`字段类型
  - 自增整数类型
    - 数据库会在插入数据时自动为每一条记录分配一个自增整数，这样我们就完全不用担心主键重复，也不用自己预先生成主键
  - 全局唯一GUID类型
    - 使用一种全局唯一的字符串作为主键，类似`8f55d96b-8acc-4636-8cb8-76bf8abc2f57`
    - GUID算法通过网卡MAC地址、时间戳和随机数保证任意计算机在任意时间生成的字符串都是不同的，大部分编程语言都内置了GUID算法，可以自己预算出主键
- 联合主键
  - 通过多个字段唯一标识记录，即两个或更多的字段都设置为主键
  - 没有必要的情况下，我们尽量不使用联合主键，因为它给关系表带来了复杂度的上升

#### 2. 外键

- 简介

  - 关系数据库通过外键可以实现一对多、多对多和一对一的关系
  - 既可以通过数据库来约束，也可以不设置约束，仅依靠应用程序的逻辑来保证

- 实现

  - 添加

    - ```sql
      ALTER TABLE students
      ADD CONSTRAINT fk_class_id
      FOREIGN KEY (class_id)
      REFERENCES classes (id);
      ```

    - 外键约束的名称`fk_class_id`可以任意

    - `FOREIGN KEY (class_id)`指定了`class_id`这一个字段作为外键

    - `REFERENCES classes (id)`指定了这个外键将关联到`classes`表的`id`列（即`classes`表的主键）
    
  - 删除

    - ```sql
      ALTER TABLE students
      DROP FOREIGN KEY fk_class_id;
      ```

    - 删除外键约束并没有删除外键这一列

- 作用

  - 优势
    - 通过定义外键约束，关系数据库可以保证无法插入无效的数据
  - 问题
    - 会降低数据库的性能
    - 因此，大部分互联网应用程序为了追求速度，并不设置外键约束，而是仅靠应用程序自身来保证逻辑的正确性

- 对应关系

  - 一对一
    - 一个表的记录对应到另一个表的唯一一个记录
    - 如果业务允许，完全可以把两个表合为一个表
    - 但是拆分成两个表可以把经常读取和不经常读取的字段分开，以获得更高的性能
  - 一对多
    - 通过一个表的外键关联到另一个表
  - 多对多
    - 通过两个一对多关系实现的，即通过一个中间表，关联两个一对多关系，就形成了多对多关系

#### 3. 索引

- 简介

  - 索引是关系数据库中对某一列或多个列的值进行预排序的数据结构
  - 通过使用索引，可以让数据库系统不必扫描整个表，而是直接定位到符合条件的记录，这样就大大加快了查询速度
  - 可以对一张表创建多个索引
  - 索引对于用户和应用程序来说都是透明的，无论是否创建索引，对于用户和应用程序来说，除了执行速度的差异外，使用关系数据库不会有任何区别

- 使用

  - ```sql
    ALTER TABLE students
    ADD INDEX idx_score (score);
    ```

  - 名称为`idx_score`，索引名称是任意的

  - 使用列`score`，索引如果有多列，可以在括号里依次写上

- 补充

  - 散列
    - 索引的效率取决于索引列的值是否散列，即该列的值如果越互不相同，那么索引效率越高
    - 反过来，如果记录的列存在大量相同的值，则对该列创建索引就没有意义
  - 主键
    - 对于主键，关系数据库会自动对其创建主键索引
    - 使用主键索引的效率是最高的，因为主键会保证绝对唯一

- 优缺

  - 优点
    - 索引的优点是提高了查询效率
  - 缺点
    - 缺点是在插入、更新和删除记录时，需要同时修改索引，因此，索引越多，插入、更新和删除记录的速度就越慢

- 唯一索引

  - 简介

    - 在设计关系数据表的时候，看上去唯一的列，例如身份证号、邮箱地址等，因为他们具有业务含义，因此不宜作为主键
    - 但是，这些列根据业务要求，又具有唯一性约束
    - 这个时候，就可以给该列添加一个唯一索引

  - 使用

    - ```sql
      ALTER TABLE students
      ADD UNIQUE INDEX uni_name (name);
      ```

    - 也可以只对某一列添加一个唯一约束而不创建唯一索引

    - ```sql
      ALTER TABLE students
      ADD CONSTRAINT uni_name UNIQUE (name);
      ```

### 4. 在线 SQL

- 简介
  - 为了便于在线练习，我们提供了一个在线运行SQL的功能
  - 由于数据只存在于浏览器的内存中，因此，如果修改了数据，重新刷新页面后，数据会重置为初始值

### 5. 查询

#### 1. 基本查询

- 使用

  - ```sql
    SELECT * FROM <表名>
    ```

  - `SELECT`是关键字，表示将要执行一个查询

  - `*`表示“所有列”

  - `FROM`表示将要从哪个表查询，可以省略，用作直接计算出表达式的结果

#### 2. 条件查询

- 使用

  - ```sql
    SELECT * FROM <表名> WHERE <条件表达式>
    ```

- 条件分类

  - `AND`

    - ```sql
      SELECT * FROM students WHERE score >= 80 AND gender = 'M';
      ```

    - 注意字符串需要用单引号括起来

  - `OR`

    - ```sql
      SELECT * FROM students WHERE score >= 80 OR gender = 'M';
      ```

  - `NOT`或者`<>`

    - ```sql
      SELECT * FROM students WHERE NOT class_id = 2;
      -- 或者 class_id <> 2
      ```

  - 其他常用的条件表达式

    - `=, >, >=, <, <=`

    - `LIKE`

      - ```sql
        name LIKE 'ab%'
        ```

      - %表示任意字符，例如'ab%'将匹配'ab'，'abc'，'abcd'

- 优先级

  - 如果不加括号，条件运算按照`NOT`、`AND`、`OR`的优先级进行

#### 3. 投影查询

- 简介

  - 如果我们只希望返回某些列的数据，而不是所有列的数据，我们可以用`SELECT 列1, 列2, 列3 FROM ...`，让结果集仅包含指定列

  - 并且，结果集的列的顺序和原表可以不一样

  - 还可以给每一列起个别名，语法是`SELECT 列1 别名1, 列2 别名2, 列3 别名3 FROM ...`

  - ```sql
    SELECT id, score points, name FROM students WHERE gender = 'M';
    ```

#### 4. 排序

- 使用

  - ```sql
    SELECT id, name, gender, score FROM students ORDER BY score DESC, gender;
    ```

  - 加上`DESC`表示“倒序”，默认的排序规则是`ASC`：“升序”，即从小到大，可以省略

  - 可以使用多个列进行排序

  - 如果有`WHERE`子句，那么`ORDER BY`子句要放到`WHERE`子句后面

#### 5. 分页查询

- 简介

  - 使用SELECT查询时，如果结果集数据量很大，可以设定分页显示，每次显示特定行数
  - 分页实际上就是从结果集中“截取”出第M~N条记录

- 使用

  - ```sql
    SELECT id, name, gender, score
    FROM students
    ORDER BY score DESC
    LIMIT 3 OFFSET 0;
    ```

  - `LIMIT 3 OFFSET 0`表示，对结果集从0号记录开始，最多取3条

  - `LIMIT 3`表示的意思是“最多3条记录”，如果只有一条记录则只会显示一条

  - `OFFSET`

    - `OFFSET`超过了查询的最大数量并不会报错，而是得到一个空的结果集
    - `OFFSET`是可选的，默认为`OFFSET 0`

  - 在MySQL中，`LIMIT 15 OFFSET 30`还可以简写成`LIMIT 30, 15`

- 步骤

  - 分页查询的关键在于，首先要确定每页需要显示的结果数量`pageSize`（这里是3）
  - 然后根据当前页的页数`N`（从1开始），确定`LIMIT`和`OFFSET`应该设定的值
  - `LIMIT`总是设定为`pageSize`
  - `OFFSET`计算公式为`pageSize * (N - 1)`
  - 这样就能正确查询出第`N`页的记录集

- 补充
  - 使用`LIMIT <M> OFFSET <N>`分页时，随着`N`越来越大，查询效率也会越来越低

#### 6. 聚合查询

- 简介

  - 对于统计总数、平均数这类计算，SQL提供了专门的聚合函数，使用聚合函数进行查询，就是聚合查询

- 使用

  | 函数  | 说明                                   |
  | ----- | -------------------------------------- |
  | COUNT | 计算某一列的行数                       |
  | SUM   | 计算某一列的合计值，该列必须为数值类型 |
  | AVG   | 计算某一列的平均值，该列必须为数值类型 |
  | MAX   | 计算某一列的最大值                     |
  | MIN   | 计算某一列的最小值                     |

  - ```sql
    SELECT AVG(score) average FROM students WHERE gender = 'M';
    ```

- 注意

  - `MAX()`和`MIN()`函数并不限于数值类型。如果是字符类型，`MAX()`和`MIN()`会返回排序最后和排序最前的字符
  - 如果聚合查询的`WHERE`条件没有匹配到任何行，`COUNT()`会返回0，而`SUM()`、`AVG()`、`MAX()`和`MIN()`会返回`NULL`

- 分组

  - ```sql
    SELECT class_id, COUNT(*) num FROM students GROUP BY class_id;
    ```

  - 可以使用多个列进行分组

  - 注意，聚合查询中，`SELECT`后面只能选取即放入分组的列（`GROUP BY`后面的列）

#### 7. 多表查询

- 笛卡尔查询

  - ```sql
    SELECT * FROM students, classes;
    ```

  - 这种一次查询两个表的数据，查询的结果也是一个二维表，它是`students`表和`classes`表的“乘积”，即`students`表的每一行与`classes`表的每一行都两两拼在一起返回

  - 结果集的列数是`students`表和`classes`表的列数之和，行数是`students`表和`classes`表的行数之积

- 给表设置别名

  - ```sql
    SELECT
        s.id sid, s.name, s.gender, s.score, c.id cid, c.name cname
    FROM students s, classes c;
    ```

  - 多表查询时，要使用`表名.列名`这样的方式来引用列和设置别名，这样就避免了结果集的列名重复问题

  - SQL还允许给表设置一个别名，让我们在投影查询中引用起来稍微简洁一点

  - 这样我们用别名`s`和`c`分别表示`students`表和`classes`表

- `WHERE`

  - ```SQL
    SELECT
        s.id sid, s.name, s.gender, s.score, c.id cid, c.name cname
    FROM students s, classes c
    WHERE s.gender = 'M' AND c.id = 1;
    ```

#### 8. 连接查询

- 简介

  - 连接查询是另一种类型的多表查询
  - 简单地说，就是先确定一个主表作为结果集，然后，把其他表的行有选择性地“连接”在主表结果集上

- 内连接

  - ```sql
    SELECT s.id, s.name, s.class_id, c.name class_name, s.gender, s.score
    FROM students s
    INNER JOIN classes c
    ON s.class_id = c.id;
    ```

  - 先确定主表，仍然使用`FROM <表1>`的语法

  - 再确定需要连接的表，使用`INNER JOIN <表2>`的语法

  - 然后确定连接条件，使用`ON <条件...>`，这里的条件是`s.class_id = c.id`，表示`students`表的`class_id`列与`classes`表的`id`列相同的行需要连接

  - 可选：加上`WHERE`子句、`ORDER BY`等子句

- 分类

  - 内连接
    - `INNER JOIN`只返回同时存在于两张表的行数据
  - 外右连接
    - `RIGHT OUTER JOIN`返回右表都存在的行。如果某一行仅在右表存在，那么结果集就会以`NULL`填充剩下的字段
  - 外左连接
    - `LEFT OUTER JOIN`正好相反，返回左表都存在的行
  - 外全连接
    - `FULL OUTER JOIN`会把两张表的所有记录全部选择出来

### 6. 修改数据

- 关系数据库的基本操作就是增删改查，即CRUD：Create、Retrieve、Update、Delete

#### 1. `INSERT`

- 

#### 2. `UPDATE`

#### 3. `DELETE`