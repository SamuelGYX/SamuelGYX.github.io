---
layout: post
title:  2020 暑期实习面试记录
date:   2020-06-02
categories: 面试准备
---

## 腾讯

python 闭包

在 64 位系统里，一个类里面有一个 int 变量，这个类的大小是多少

32 位，64 位系统，指针的大小分别是多少

tcp，udp 区别

怎么提升 udp 的可靠性

TIME_WAIT 和 CLOSE_WAIT 什么区别

select，epoll 区别

如何实现一个 hash_map

如果有碰撞怎么处理

怎么实现 lru 算法

3 L，5 L 的杯子，如何得到 4 L 的水



## 艾耕科技

有什么兴趣爱好

- 看游戏视频，看书

最近有没有完整阅读过一本技术方面的书，有什么感想

- 算法导论

介绍一个曾经的项目

- SSHFS

如果在发送请求的过程中丢包，如何解决

- 用 log 记录最近的操作，如果某个请求失败就返回到该请求之前的状态

请求队列的数据结构是如何设计的？

- 双链表，每一个节点有指向 prev 和 next 的指针，以及存储对应的请求

每一个请求是如何记录不同的类型，操作？

- 简单的理解，**fuse实现了一个对文件系统访问的回调**。fuse分为**内核态的模块和用户态的库**两部分。其中**用户态的库**为程序开发提供接口，我们通过这些接口将请求处理功能注册到fuse中。**内核态模块**是具体的数据流程的功能实现，它截获文件的访问请求，然后调用用户态注册的函数进行处理。
- 其中fuse_user是开发的用户态的文件系统程序，该程序启动的时候会将自己开发的接口注册到fuse中，**比如读写文件的接口，遍历目录的接口**等等。
- 同时，通过该程序在系统某个路径挂载fuse文件系统，比如/tmp/file_on_fuse_fs。此时如果在该目录中有相关操作时，请求会经过VFS到fuse的内核模块，fuse内核模块根据请求类型，调用用户态应用注册的函数，然后将处理结果通过VFS返回给系统调用。
- 每个请求对应一个 request 结构体，维护一个全局的 hash table，收到用户请求时注册 request，构建对应格式的 ssh 请求，将 requst 插入哈希表，将 ssh 请求发送给服务器，收到服务器回复时，通过收到的返回 id 从哈希表中取得对应的 request，然后调用这个 request 中的处理函数对回复的数据进行处理。
- request 结构体存储请求 ID，请求类型，file handle，偏移量，读取大小，对应 buffer 的指针，是否收到回复，收到的回复的类型，处理回复的函数，与服务器的连接。
- 我们的思路是修改发送请求的函数，在每次发送请求之前，先在本地的缓存中查找是否有对应数据，如果满足则直接使用缓存答复用户请求，如果不满足，则再把请求加入请求队列中，由另一个线程取出，发送给 server，收到 server 的回复时由之前已经存在的函数处理。
- 读取到本地缓存的数据，但是 server 上的数据已经被更改：
  - 该系统的使用场景主要面向私有 server，所以原系统的设计中就没有过多涉及一致性的问题
  - 我们的缓存会预先设定好 valid interval，比如 20 秒，某个文件的缓存经过这段时间就会自动失效，之后就会从 server 上重新读取，这样一段短暂的时间一般不会有严重的读写冲突
  - 在长时间没有网络的时间里，server 上的文件应该是
  - 如果在这段时间里，有可能 client 更改和 server 更改有冲突，我们本来想要设计能够让用户自己选择保留哪个版本，但是 user space 内的程序的返回数据需要先发送给 kernel，然后由 kernel 回复给对应的用户程序，比如一个 editor，这样的话回复内容是受到限制的，我们因为时间原因最后没有实现这个功能，所以如果有不一致的话还是按照 server 上的版本为准
  - 使用轮询的方式，每过一段时间自动读取 server 上的文件，检查本地的数据是否一致
- 如果前一个请求失败，比如网络丢包，或者服务端报错：
  - 首先这种情况是比较少见的
  - 对于一些常见的服务端报错，这个系统都可以把这些错误映射到本地的错误，比如权限不足，就会给用户返回权限不足的错误
  - 如果真的有丢包现象，一般就是说明网络连接被断开了，这个请求没有得到回复，就会一直被暂时存放在队列里面，等待网络恢复之后再重新发送
  - 如果经过这段时间，发现 server 上的文件已经被修改了，队列里的请求无法写入 server
  - 我们有查到不同的方案解决冲突，比如 OT 算法，把操作转换为可以兼容的等价操作，但是也是
  - 使用 log 记录所有的操作，如果某个操作失败则回滚到该操作完成之前的状态
- 如果网络一直无法连通：
  - 则将当前状态存储，例如内存数据，缓存数据，队列数据存储为一个永久性的文件

